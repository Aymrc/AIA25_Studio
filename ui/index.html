<!DOCTYPE html>
<html>

	<head>

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Cop:lot</title>
		<link rel="stylesheet" href="copilot.css">

		<link rel="icon" type="image/png" href="copilot_icon.svg">

	</head>

	<body>
        <div class="copTitle">Cop:lot</div>


        <div class="box" id="Chat">
			<h2>Copilot Chat</h2>
				<div id="chatbox">
					<!-- Initial greeting will be loaded here -->
				</div>
				
				<!-- user input -->
				<div id="input">
					<input type="text" id="message" placeholder="Type your question..." style="width: 70%;">
					<button onclick="sendMessage()">Send</button>
				</div>

				<!-- script for chatbot calling server -->
				<script>
				// Load initial greeting when page loads
				window.addEventListener("load", async function() {
					try {
						const res = await fetch("http://127.0.0.1:5001/initial_greeting");
						const data = await res.json();
						
						if (data.response) {
							addToChat("bot", data.response);
						}
					} catch (err) {
						console.error("Could not load initial greeting:", err);
						addToChat("bot", "Hello! I'm your design assistant. What would you like to build today?");
					}
				});

				async function sendMessage() {
					const input = document.getElementById("message");
					const chatbox = document.getElementById("chatbox");

					const userMsg = input.value.trim();
					if (!userMsg) return;

					addToChat("user", userMsg);
					input.value = "";


					// "Copilot is typing ..."
					const typingMsg = document.createElement("div");
					typingMsg.className = "bot typing";
					typingMsg.textContent = "Copilot is thinking...";
					chatbox.appendChild(typingMsg);
					chatbox.scrollTop = chatbox.scrollHeight;

					fetch("http://127.0.0.1:5001/")
						.then(res => res.json())
						.then(data => console.log("Server status:", data))
						.catch(err => console.error("Status check failed:", err));

					try {
					const res = await fetch("http://127.0.0.1:5001/chat", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ message: userMsg })
					});

					const data = await res.json();

					// Remove typing indicator
					chatbox.removeChild(typingMsg);

					// Show copilot response
					if (data.error) {
						addToChat("bot", "❌ " + data.response);
					} else {
						addToChat("bot", data.response);
						
						// Update data section if design parameters changed
						if (data.design_data && Object.keys(data.design_data).length > 0) {
							updateDataSection(data.design_data, data.state);
						}
					}
					} catch (err) {
					console.error("Fetch error:", err);
					chatbox.removeChild(typingMsg);
					addToChat("bot", "Error contacting the assistant.");
					}
				}

				function addToChat(role, text) {
					const chat = document.getElementById("chatbox");
					const msg = document.createElement("div");
					msg.className = role;
					msg.textContent = (role === "user" ? "You: " : "Copilot: ") + text;
					chat.appendChild(msg);
					chat.scrollTop = chat.scrollHeight;
				}

				function updateDataSection(designData, state) {
					const dataContent = document.getElementById("dataContent");
					
					let content = `<h4>Current Parameters (${state})</h4><ul>`;
					
					if (designData.building_type) {
						content += `<li><strong>Building Type:</strong> ${designData.building_type}</li>`;
					}
					
					if (designData.geometry) {
						const geom = designData.geometry;
						content += `<li><strong>Geometry:</strong>`;
						if (geom.typology) content += ` ${geom.typology}`;
						if (geom.number_of_levels) content += `, ${geom.number_of_levels} levels`;
						if (geom.width_m && geom.depth_m) content += `, ${geom.width_m}×${geom.depth_m}m`;
						content += `</li>`;
					}
					
					if (designData.materiality) {
						content += `<li><strong>Material:</strong> ${designData.materiality}</li>`;
					}
					
					if (designData.climate) {
						content += `<li><strong>Climate:</strong> ${designData.climate}</li>`;
					}
					
					if (designData.wwr) {
						content += `<li><strong>Windows:</strong> ${Math.round(designData.wwr * 100)}%</li>`;
					}
					
					content += `</ul>`;
					
					if (state === "complete") {
						content += `<p style="color: green;"><strong>✅ Parameter collection complete!</strong></p>`;
					}
					
					dataContent.innerHTML = content;
				}

				document.getElementById("message").addEventListener("keydown", function(event) {
				if (event.key === "Enter") {
					event.preventDefault();
					sendMessage();
				}
				});
				</script>
		</div>

        <div class="box" id="Data">
            <h3>Data</h3>
  			<div id="dataContent">No data yet.</div>
        </div>



        <div class="box" id="Viz">
			<h3>Vizualisation</h3>

  			<div id="vizGrid" class="viz-grid"> 
				<div class="viz-tile empty">Waiting for image...</div>
				<!-- basic grid placeholder -->

				<!-- JS script for adding new tile when you image avaiable -->
				<script>
					function loadVizGallery() {
					const grid = document.getElementById("vizGrid");
					grid.innerHTML = "";

					let i = 0;

					const tryNext = () => {
						const imgPath = `../KNOWLEDGE/V${i}.png`;
						// checking for the version
						// make sure the folder is right!

						const img = new Image();
						img.onload = function () {
							const tile = document.createElement("div");
							tile.className = "viz-tile";

							const label = document.createElement("div");
							label.className = "viz-label";
							label.textContent = `V${i}`;

							tile.appendChild(img);
							tile.appendChild(label);

							grid.appendChild(tile);

							i++;
							tryNext();
						};

						img.onerror = function () {
						if (i === 0) {
							const empty = document.createElement("div");
							empty.className = "viz-tile empty";
							empty.textContent = "No images yet.";
							grid.appendChild(empty);
						}
						};

						img.src = imgPath;
					};

					tryNext();
					}

					window.addEventListener("load", loadVizGallery);
					</script>

			</div>
		</div>
	</body>
</html>