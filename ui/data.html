<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cop:lot - Chat</title>

    <link rel="stylesheet" href="copilot_common.css">
    <link rel="stylesheet" href="copilot_data.css">

    <link rel="icon" type="image/png" href="assets/copilot_icon.svg">
</head>

    <body>
        <div class="glow-line"></div>
        <div class="copTitle">Copilot Data</div>
		
		
		<div class="main_container">

			<!-- layer composition material -->
			<div class="tableComp">
				<h3>Building Composition</h3>
					<table id="compositionTable">

						<thead>
						<tr>
							<th>Component</th>
							<th>Material</th>
						</tr>
						</thead>

						<tbody>
							<!-- JavaScript inputs -->
						</tbody>
					</table>
			</div>
			<!-- js for the material table -->
			<script>
				function loadTableData() {
					fetch("http://127.0.0.1:5001/api/ml_output")
					.then(res => res.json())
					.then(data => {
						const decoded = data.inputs_decoded;
						const tableBody = document.querySelector("#compositionTable tbody");
						tableBody.innerHTML = ""; // Clear previous rows

						for (const [component, material] of Object.entries(decoded)) {
							if (typeof material === "string") {
								const row = document.createElement("tr");
								const compCell = document.createElement("td");
								const matCell = document.createElement("td");

								compCell.textContent = component.replaceAll("_", " ").replaceAll(".", " "); // Clean names
								matCell.textContent = material.replaceAll("_", " ");

								row.appendChild(compCell);
								row.appendChild(matCell);
								tableBody.appendChild(row);
							}
						}
					})
					.catch(err => {
						console.error("Error loading composition:", err);
						const tableBody = document.querySelector("#compositionTable tbody");
						tableBody.innerHTML = `<tr><td colspan="2">Failed to load data.</td></tr>`;
					});
				}
				loadTableData();

				setInterval(loadTableData, 3000); // 3 sec check
			</script>


			<!-- plot GWP & other metrics -->
			<div class="plotGWP">
				<h3>Sustainability Trend</h3>

				<label for="metricSelect">Select Metric:</label>
				<select id="metricSelect">
					<option value="GWP total (kg CO2e/m²a GFA)">GWP total</option>
					<option value="Operational Carbon (kg CO2e/m²a GFA)">Op. Carbon</option>
					<option value="Embodied Carbon A-D (kg CO2e/m²a GFA)">EC A-D</option>
					<option value="Energy Intensity - EUI (kWh/m²a)">EUI</option>
					<option value="Cooling Demand (kWh/m²a)">Cooling</option>
					<option value="Heating Demand (kWh/m²a)">Heating</option>
				</select>


				<div id="gwp-plot" style="width:100%; height:400px;"></div>
			</div>
		

			<!-- Gallery Iterations -->
			<div class="gallerySection" id="gallery">
				<h3>Vizualisation</h3>

				<div id="vizGrid" class="viz-grid"> 
					<div class="viz-tile empty">Waiting for image...</div>
					<!-- basic grid placeholder -->

					<!-- JS script for adding new tile when you image avaiable -->
					<script>
						function loadVizGallery() {
						const grid = document.getElementById("vizGrid");
						grid.innerHTML = "";

						let i = 0;

						const tryNext = () => {
							const imgPath = `../knowledge/iterations/V${i}.png`;
							
							// checking for the version
							// make sure the folder is right!

							const img = new Image();
							img.onload = function () {
								const tile = document.createElement("div");
								tile.className = "viz-tile";

								const label = document.createElement("div");
								label.className = "viz-label";
								label.textContent = `V${i}`;

								tile.appendChild(img);
								tile.appendChild(label);

								grid.appendChild(tile);

								i++;
								tryNext();
							};

							img.onerror = function () {
							if (i === 0) {
								const empty = document.createElement("div");
								empty.className = "viz-tile empty";
								empty.textContent = "No images yet.";
								grid.appendChild(empty);
							}
							};

							img.src = imgPath;
						};

						tryNext();
						}

						window.addEventListener("load", loadVizGallery);
						</script>

				</div>
			</div>


			<!-- js for plotly -->
			<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
			<script>
				window.addEventListener("load", () => {
					const select = document.getElementById("metricSelect");

					// Simulated example data (replace or fetch real gwpData)
					// Make sure this exists OR fetch from a real API
					if (!window.gwpData || gwpData.length === 0) {
						console.warn("No gwpData found or empty.");
						document.getElementById("gwp-plot").innerText = "No data yet.";
						return;
					}

					const displayNames = {
						"GWP total (kg CO2e/m²a GFA)": "GWP total",
						"Operational Carbon (kg CO2e/m²a GFA)": "Op. Carbon",
						"Embodied Carbon A-D (kg CO2e/m²a GFA)": "EC A-D",
						"Energy Intensity - EUI (kWh/m²a)": "EUI",
						"Cooling Demand (kWh/m²a)": "Cooling",
						"Heating Demand (kWh/m²a)": "Heating",
					};

					function plotMetric(metricName) {
						const filtered = gwpData.filter(d => typeof d[metricName] === "number" && !isNaN(d[metricName]));

						const x = filtered.map(d => d.version);
						const y = filtered.map(d => d[metricName]);

						const min = Math.min(...y);
						const max = Math.max(...y);
						const minIndex = y.indexOf(min);
						const maxIndex = y.indexOf(max);

						const shortName = displayNames[metricName] || metricName;

						const trace = {
							x: x,
							y: y,
							type: 'scatter',
							mode: 'markers',
							marker: {
								size: 15,
								color: y,
								colorscale: [
									[0, 'da70d6'],
									[0.5, 'ffd700'],
									[1, 'add8e6']
								],
								reversescale: true,
								cmin: min,
								cmax: max,
								colorbar: {
									title: {
										text: metricName,
										font: { size: 12 }
									},
									thickness: 15
								}
							},
							hovertemplate: `Version: %{x}<br>${metricName}: %{y}<extra></extra>`
						};

						Plotly.newPlot('gwp-plot', [trace], {
							title: `${metricName} per Design Iteration`,
							xaxis: {
								title: 'Version',
								fixedrange: false,
								tickmode: 'linear'
							},
							yaxis: {
								title: `${metricName}`,
								fixedrange: false,
								range: [0, max + 20]
							},
							dragmode: 'pan',
							margin: { t: 40 },
							annotations: [
								{
									x: x[minIndex],
									y: min,
									text: "Best",
									showarrow: false,
									yshift: -15,
									font: { color: 'add8e6', size: 12 }
								},
								{
									x: x[maxIndex],
									y: max,
									text: "",
									showarrow: false,
									yshift: -15,
									font: { color: 'red', size: 12 }
								}
							]
						});
					}

					plotMetric(select.value);
					select.addEventListener("change", () => {
						plotMetric(select.value);
					});
				});
			</script>

		</div>

    </body>
</html>
